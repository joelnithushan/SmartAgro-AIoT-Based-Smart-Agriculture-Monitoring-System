import React, { useState, useEffect } from 'react';import { useAuth } from '../contexts/AuthContext';import { sensorDataService } from '../services/firestoreService';import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';const SensorDataDisplay = ({ deviceId }) => {  const { currentUser } = useAuth();  const [sensorData, setSensorData] = useState([]);  const [loading, setLoading] = useState(true);  const [error, setError] = useState(null);  const [latestData, setLatestData] = useState(null);  useEffect(() => {    if (!deviceId || !currentUser?.uid) {      setLoading(false);      return;    }    console.log('üîÑ Setting up real-time subscription for sensor data:', deviceId);    const unsubscribe = sensorDataService.subscribeToDeviceSensorData(      deviceId,      (data) => {        console.log('üì• Received sensor data:', data.length);        setSensorData(data);        setLatestData(data[0] || null);        setLoading(false);        setError(null);      }    );    return () => {      console.log('üîÑ Unsubscribing from sensor data');      unsubscribe();    };  }, [deviceId, currentUser?.uid]);  const formatChartData = (data) => {    return data.map(item => ({      time: new Date(item.timestamp?.toDate?.() || item.timestamp).toLocaleTimeString(),      soilMoisture: item.soilMoisture || 0,      temperature: item.temperature || 0,      humidity: item.humidity || 0,      airQuality: item.airQuality || 0,      rainLevel: item.rainLevel || 0,      lightLevel: item.lightLevel || 0    })).reverse();   };  const getStatusColor = (value, type) => {    switch (type) {      case 'soilMoisture':        return value < 30 ? 'text-red-500' : value < 60 ? 'text-yellow-500' : 'text-green-500';      case 'temperature':        return value < 15 ? 'text-blue-500' : value > 35 ? 'text-red-500' : 'text-green-500';      case 'humidity':        return value < 30 ? 'text-red-500' : value > 80 ? 'text-blue-500' : 'text-green-500';      case 'airQuality':        return value > 100 ? 'text-red-500' : value > 50 ? 'text-yellow-500' : 'text-green-500';      default:        return 'text-gray-500';    }  };  const getStatusText = (value, type) => {    switch (type) {      case 'soilMoisture':        return value < 30 ? 'Dry' : value < 60 ? 'Moderate' : 'Wet';      case 'temperature':        return value < 15 ? 'Cold' : value > 35 ? 'Hot' : 'Normal';      case 'humidity':        return value < 30 ? 'Low' : value > 80 ? 'High' : 'Normal';      case 'airQuality':        return value > 100 ? 'Poor' : value > 50 ? 'Moderate' : 'Good';      default:        return 'Normal';    }  };  if (loading) {    return (      <div className="bg-gray-800 rounded-xl p-6 border border-gray-700">        <div className="flex items-center justify-center py-8">          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div>          <span className="ml-3 text-gray-400">Loading sensor data...</span>        </div>      </div>    );  }  if (error) {    return (      <div className="bg-gray-800 rounded-xl p-6 border border-gray-700">        <div className="text-center py-8">          <div className="text-red-500 text-4xl mb-4">‚ö†Ô∏è</div>          <p className="text-red-400">{error}</p>        </div>      </div>    );  }  if (!deviceId) {    return (      <div className="bg-gray-800 rounded-xl p-6 border border-gray-700">        <div className="text-center py-8">          <div className="text-gray-500 text-4xl mb-4">üì±</div>          <h3 className="text-lg font-medium text-gray-300 mb-2">No Device Assigned</h3>          <p className="text-gray-500">You need a device assigned to view sensor data.</p>        </div>      </div>    );  }  if (sensorData.length === 0) {    return (      <div className="bg-gray-800 rounded-xl p-6 border border-gray-700">        <div className="text-center py-8">          <div className="text-gray-500 text-4xl mb-4">üìä</div>          <h3 className="text-lg font-medium text-gray-300 mb-2">No Sensor Data</h3>          <p className="text-gray-500">No sensor data available for device {deviceId}.</p>        </div>      </div>    );  }  const chartData = formatChartData(sensorData);  return (    <div className="bg-gray-800 rounded-xl p-6 border border-gray-700">      <div className="flex items-center justify-between mb-6">        <div className="flex items-center space-x-3">          <div className="p-3 bg-green-500/20 rounded-lg">            <svg className="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />            </svg>          </div>          <div>            <h2 className="text-xl font-semibold text-white">Real-time Sensor Data</h2>            <p className="text-sm text-gray-400">              Device: {deviceId} ‚Ä¢ {sensorData.length} readings            </p>          </div>        </div>      </div>      {}      {latestData && (        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">          <div className="bg-gray-700/50 rounded-lg p-4">            <div className="flex items-center justify-between">              <div>                <p className="text-sm text-gray-400">Soil Moisture</p>                <p className={`text-2xl font-bold ${getStatusColor(latestData.soilMoisture, 'soilMoisture')}`}>                  {latestData.soilMoisture?.toFixed(1) || 'N/A'}%                </p>                <p className="text-xs text-gray-500">{getStatusText(latestData.soilMoisture, 'soilMoisture')}</p>              </div>              <div className="text-2xl">üíß</div>            </div>          </div>          <div className="bg-gray-700/50 rounded-lg p-4">            <div className="flex items-center justify-between">              <div>                <p className="text-sm text-gray-400">Temperature</p>                <p className={`text-2xl font-bold ${getStatusColor(latestData.temperature, 'temperature')}`}>                  {latestData.temperature?.toFixed(1) || 'N/A'}¬∞C                </p>                <p className="text-xs text-gray-500">{getStatusText(latestData.temperature, 'temperature')}</p>              </div>              <div className="text-2xl">üå°Ô∏è</div>            </div>          </div>          <div className="bg-gray-700/50 rounded-lg p-4">            <div className="flex items-center justify-between">              <div>                <p className="text-sm text-gray-400">Humidity</p>                <p className={`text-2xl font-bold ${getStatusColor(latestData.humidity, 'humidity')}`}>                  {latestData.humidity?.toFixed(1) || 'N/A'}%                </p>                <p className="text-xs text-gray-500">{getStatusText(latestData.humidity, 'humidity')}</p>              </div>              <div className="text-2xl">üí®</div>            </div>          </div>          <div className="bg-gray-700/50 rounded-lg p-4">            <div className="flex items-center justify-between">              <div>                <p className="text-sm text-gray-400">Air Quality</p>                <p className={`text-2xl font-bold ${getStatusColor(latestData.airQuality, 'airQuality')}`}>                  {latestData.airQuality?.toFixed(0) || 'N/A'}                </p>                <p className="text-xs text-gray-500">{getStatusText(latestData.airQuality, 'airQuality')}</p>              </div>              <div className="text-2xl">üå¨Ô∏è</div>            </div>          </div>        </div>      )}      {}      <div className="space-y-6">        {}        <div className="bg-gray-700/30 rounded-lg p-4">          <h3 className="text-lg font-medium text-white mb-4">Soil Moisture Trend</h3>          <ResponsiveContainer width="100%" height={200}>            <LineChart data={chartData}>              <CartesianGrid strokeDasharray="3 3" stroke="#374151" />              <XAxis dataKey="time" stroke="#9CA3AF" />              <YAxis stroke="#9CA3AF" />              <Tooltip                 contentStyle={{                   backgroundColor: '#374151',                   border: '1px solid #6B7280',                  borderRadius: '8px',                  color: '#F9FAFB'                }}               />              <Line                 type="monotone"                 dataKey="soilMoisture"                 stroke="#10B981"                 strokeWidth={2}                dot={{ fill: '#10B981', strokeWidth: 2, r: 4 }}              />            </LineChart>          </ResponsiveContainer>        </div>        {}        <div className="bg-gray-700/30 rounded-lg p-4">          <h3 className="text-lg font-medium text-white mb-4">Temperature & Humidity</h3>          <ResponsiveContainer width="100%" height={200}>            <LineChart data={chartData}>              <CartesianGrid strokeDasharray="3 3" stroke="#374151" />              <XAxis dataKey="time" stroke="#9CA3AF" />              <YAxis stroke="#9CA3AF" />              <Tooltip                 contentStyle={{                   backgroundColor: '#374151',                   border: '1px solid #6B7280',                  borderRadius: '8px',                  color: '#F9FAFB'                }}               />              <Legend />              <Line                 type="monotone"                 dataKey="temperature"                 stroke="#EF4444"                 strokeWidth={2}                dot={{ fill: '#EF4444', strokeWidth: 2, r: 4 }}                name="Temperature (¬∞C)"              />              <Line                 type="monotone"                 dataKey="humidity"                 stroke="#3B82F6"                 strokeWidth={2}                dot={{ fill: '#3B82F6', strokeWidth: 2, r: 4 }}                name="Humidity (%)"              />            </LineChart>          </ResponsiveContainer>        </div>      </div>      {}      <div className="mt-4 pt-4 border-t border-gray-600">        <p className="text-xs text-gray-500">          Last updated: {latestData ? new Date(latestData.timestamp?.toDate?.() || latestData.timestamp).toLocaleString() : 'N/A'}        </p>      </div>    </div>  );};export default SensorDataDisplay;