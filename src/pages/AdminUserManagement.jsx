import React, { useState, useEffect } from 'react';import { useAuth } from '../contexts/AuthContext';import { Navigate } from 'react-router-dom';import { collection, onSnapshot, query, orderBy, getDoc, doc } from 'firebase/firestore';import { db } from '../config/firebase';import { apiService } from '../services/api';const AdminUserManagement = () => {  const { currentUser } = useAuth();  const [users, setUsers] = useState([]);  const [loading, setLoading] = useState(true);  const [error, setError] = useState(null);  const [isAdmin, setIsAdmin] = useState(false);  const [adminCheckLoading, setAdminCheckLoading] = useState(true);  const [actionLoading, setActionLoading] = useState({});  useEffect(() => {    if (!currentUser) return;    const checkAdminStatus = async () => {      try {        const userDoc = await getDoc(doc(db, 'users', currentUser.uid));        if (userDoc.exists()) {          const userData = userDoc.data();          setIsAdmin(userData.roles?.admin === true);        }      } catch (error) {        console.error('Error checking admin status:', error);      } finally {        setAdminCheckLoading(false);      }    };    checkAdminStatus();  }, [currentUser]);  useEffect(() => {    if (!isAdmin) return;    let unsubscribe;    try {      const q = query(        collection(db, 'users'),        orderBy('createdAt', 'desc')      );      unsubscribe = onSnapshot(q, (snapshot) => {        const usersList = [];        snapshot.forEach((doc) => {          usersList.push({            id: doc.id,            ...doc.data()          });        });        setUsers(usersList);        setLoading(false);      }, (error) => {        console.error('Error fetching users:', error);        setError('Failed to load users');        setLoading(false);      });    } catch (error) {      console.error('Error setting up users listener:', error);      setError('Failed to set up real-time listener');      setLoading(false);    }    return () => {      if (unsubscribe) {        unsubscribe();      }    };  }, [isAdmin]);  const handleRoleChange = async (targetUid, currentRole, newValue) => {    setActionLoading(prev => ({ ...prev, [targetUid]: true }));    try {      await apiService.setUserRole(targetUid, 'admin', newValue);      console.log(`User ${newValue ? 'promoted to' : 'demoted from'} admin successfully`);    } catch (error) {      console.error('Error updating user role:', error);      alert(`Failed to update user role: ${error.message}`);    } finally {      setActionLoading(prev => ({ ...prev, [targetUid]: false }));    }  };  const formatDate = (timestamp) => {    if (!timestamp) return 'Unknown';    if (timestamp.toDate) {      return timestamp.toDate().toLocaleDateString();    }    return new Date(timestamp).toLocaleDateString();  };  if (adminCheckLoading) {    return (      <div className="min-h-screen bg-gray-900 text-white flex items-center justify-center">        <div className="text-center">          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto"></div>          <p className="mt-4 text-gray-400">Checking admin access...</p>        </div>      </div>    );  }  if (!currentUser) {    return <Navigate to="/login" replace />;  }  if (!isAdmin) {    return (      <div className="min-h-screen bg-gray-900 text-white flex items-center justify-center">        <div className="text-center">          <div className="text-red-500 text-6xl mb-4">üö´</div>          <h2 className="text-2xl font-bold text-white mb-4">Access Denied</h2>          <p className="text-gray-400 mb-6">You don't have admin privileges to access this page.</p>          <button            onClick={() => window.history.back()}            className="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200"          >            Go Back          </button>        </div>      </div>    );  }  if (loading) {    return (      <div className="min-h-screen bg-gray-900 text-white flex items-center justify-center">        <div className="text-center">          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto"></div>          <p className="mt-4 text-gray-400">Loading users...</p>        </div>      </div>    );  }  if (error) {    return (      <div className="min-h-screen bg-gray-900 text-white flex items-center justify-center">        <div className="text-center">          <div className="text-red-500 text-6xl mb-4">‚ö†Ô∏è</div>          <h2 className="text-2xl font-bold text-white mb-4">Error Loading Users</h2>          <p className="text-gray-400 mb-6">{error}</p>          <button            onClick={() => window.location.reload()}            className="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200"          >            Retry          </button>        </div>      </div>    );  }  return (    <div className="min-h-screen bg-gray-900 text-white">      {}      <div className="bg-gray-800 border-b border-gray-700 px-6 py-4">        <div className="flex items-center justify-between">          <div>            <h1 className="text-2xl font-bold text-white">User Management</h1>            <p className="text-gray-400 mt-1">Manage user roles and permissions</p>          </div>          <div className="text-sm text-gray-400">            Total Users: {users.length}          </div>        </div>      </div>      {}      <div className="p-6">        {users.length === 0 ? (          <div className="text-center py-12">            <div className="text-gray-500 text-6xl mb-4">üë•</div>            <h3 className="text-xl font-semibold text-white mb-2">No Users Found</h3>            <p className="text-gray-400">No users have been registered yet.</p>          </div>        ) : (          <div className="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">            <div className="overflow-x-auto">              <table className="min-w-full divide-y divide-gray-700">                <thead className="bg-gray-700">                  <tr>                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">                      User                    </th>                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">                      Email                    </th>                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">                      Role                    </th>                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">                      Joined                    </th>                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">                      Actions                    </th>                  </tr>                </thead>                <tbody className="bg-gray-800 divide-y divide-gray-700">                  {users.map((user) => {                    const isCurrentUser = user.id === currentUser.uid;                    const isAdmin = user.roles?.admin === true;                    const isLoading = actionLoading[user.id];                    return (                      <tr key={user.id} className={isCurrentUser ? 'bg-green-900/20' : ''}>                        <td className="px-6 py-4 whitespace-nowrap">                          <div className="flex items-center">                            <div className="flex-shrink-0 h-10 w-10">                              <div className="h-10 w-10 rounded-full bg-gray-600 flex items-center justify-center">                                <span className="text-sm font-medium text-white">                                  {user.displayName?.charAt(0)?.toUpperCase() || user.email?.charAt(0)?.toUpperCase() || '?'}                                </span>                              </div>                            </div>                            <div className="ml-4">                              <div className="text-sm font-medium text-white">                                {user.displayName || 'No Name'}                                {isCurrentUser && (                                  <span className="ml-2 text-xs bg-green-600 text-white px-2 py-1 rounded">                                    You                                  </span>                                )}                              </div>                              <div className="text-sm text-gray-400">                                {user.phone || 'No phone'}                              </div>                            </div>                          </div>                        </td>                        <td className="px-6 py-4 whitespace-nowrap">                          <div className="text-sm text-gray-300">{user.email}</div>                        </td>                        <td className="px-6 py-4 whitespace-nowrap">                          <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${                            isAdmin                               ? 'bg-purple-100 text-purple-800'                               : 'bg-gray-100 text-gray-800'                          }`}>                            {isAdmin ? 'Admin' : 'User'}                          </span>                        </td>                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-400">                          {formatDate(user.createdAt)}                        </td>                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">                          {isCurrentUser ? (                            <span className="text-gray-500">Current User</span>                          ) : (                            <div className="flex space-x-2">                              {isAdmin ? (                                <button                                  onClick={() => handleRoleChange(user.id, 'admin', false)}                                  disabled={isLoading}                                  className="inline-flex items-center px-3 py-1 border border-transparent text-xs font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed"                                >                                  {isLoading ? (                                    <svg className="animate-spin h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24">                                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>                                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>                                    </svg>                                  ) : null}                                  Demote                                </button>                              ) : (                                <button                                  onClick={() => handleRoleChange(user.id, 'admin', true)}                                  disabled={isLoading}                                  className="inline-flex items-center px-3 py-1 border border-transparent text-xs font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed"                                >                                  {isLoading ? (                                    <svg className="animate-spin h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24">                                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>                                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>                                    </svg>                                  ) : null}                                  Promote                                </button>                              )}                            </div>                          )}                        </td>                      </tr>                    );                  })}                </tbody>              </table>            </div>          </div>        )}      </div>    </div>  );};export default AdminUserManagement;