rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // ADMIN ACCESS RULES
    // ========================================
    function isAdmin() {
      return request.auth != null && 
             (request.auth.token.email == "joelnithushan6@gmail.com" || 
              request.auth.token.role in ['admin', 'superadmin']);
    }
    
    function isSuperAdmin() {
      return request.auth != null && 
             (request.auth.token.email == "joelnithushan6@gmail.com" || 
              request.auth.token.role == 'superadmin');
    }
    
    function isNormalAdmin() {
      return request.auth != null && 
             request.auth.token.role == 'admin' && 
             request.auth.token.email != "joelnithushan6@gmail.com";
    }
    
    function canModifyRoles() {
      return isSuperAdmin();
    }
    
    // ========================================
    // VALIDATION FUNCTIONS
    // ========================================
    function isValidNIC(nic) {
      return nic.matches("^[0-9]{9}[vV]$") || nic.matches("^[0-9]{12}$");
    }
    
    function isValidName(name) {
      return name.matches("^[A-Za-z ]+$") && name.size() >= 2;
    }
    
    function isValidAge(age) {
      return age is int && age >= 0 && age <= 100;
    }
    
    function isValidPrice(price) {
      return price is number && price >= 0;
    }
    
    function isValidEmail(email) {
      return email.matches("^[A-Za-z0-9]([A-Za-z0-9._%+-]*[A-Za-z0-9])?@[A-Za-z0-9]([A-Za-z0-9.-]*[A-Za-z0-9])?\\.[A-Za-z]{2,}$");
    }
    
    function isValidMobile(mobile) {
      return mobile.matches("^(?:7[0-9]{8}|0[1-9][0-9]{7}|\\+94[1-9][0-9]{7})$");
    }
    
    function isValidCropName(cropName) {
      return cropName.matches("^[A-Za-z ]+$") && cropName.size() >= 2;
    }
    
    function isFutureDate(date) {
      return date > request.time;
    }
    
    function isPastDate(date) {
      return date < request.time;
    }
    
    // ========================================
    // USER AUTHENTICATION RULES
    // ========================================
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // ========================================
    // USERS COLLECTION - CONSOLIDATED RULES
    // ========================================
    match /users/{userId} {
      // READ PERMISSIONS
      allow read: if isOwner(userId) || isAdmin();
      
      // CREATE PERMISSIONS - More permissive for user creation
      allow create: if isOwner(userId) && 
                       request.resource.data.keys().hasAny(["email"]) &&
                       (!('email' in request.resource.data) || isValidEmail(request.resource.data.email)) &&
                       (!('fullName' in request.resource.data) || request.resource.data.fullName == "" || isValidName(request.resource.data.fullName)) &&
                       (!('role' in request.resource.data) || request.resource.data.role in ['user', 'admin', 'superadmin']);
      
      // UPDATE PERMISSIONS - More permissive for user updates
      allow update: if (
        // Users can update their own profile (but not role)
        (isOwner(userId) && !('role' in request.resource.data.diff(resource.data).affectedKeys())) ||
        // Super admin can update any user (including roles)
        isSuperAdmin() ||
        // Super admin email can always update (for migration purposes)
        (request.auth != null && request.auth.token.email == "joelnithushan6@gmail.com") ||
        // Normal admin can update user profiles (but not roles)
        (isNormalAdmin() && !('role' in request.resource.data.diff(resource.data).affectedKeys()))
      ) && !(resource.data.email == "joelnithushan6@gmail.com") &&
          // Validate fields if they exist (more permissive)
          (!('fullName' in request.resource.data) || isValidName(request.resource.data.fullName)) &&
          (!('name' in request.resource.data) || isValidName(request.resource.data.name)) &&
          (!('nic' in request.resource.data) || isValidNIC(request.resource.data.nic)) &&
          (!('age' in request.resource.data) || isValidAge(request.resource.data.age)) &&
          (!('email' in request.resource.data) || isValidEmail(request.resource.data.email)) &&
          (!('mobile' in request.resource.data) || isValidMobile(request.resource.data.mobile)) &&
          (!('phone' in request.resource.data) || isValidMobile(request.resource.data.phone)) &&
          // Allow admins to update profile picture fields for migration
          (!('photoURL' in request.resource.data) || request.resource.data.photoURL is string) &&
          (!('avatar' in request.resource.data) || request.resource.data.avatar is string) &&
          (!('profilePicture' in request.resource.data) || request.resource.data.profilePicture is string) &&
          (!('migratedFromCloudinary' in request.resource.data) || request.resource.data.migratedFromCloudinary is bool) &&
          (!('migrationDate' in request.resource.data) || request.resource.data.migrationDate is string);
      
      // DELETE PERMISSIONS
      allow delete: if (
        // Users can delete their own account (self-deactivation)
        isOwner(userId) ||
        // Super admin can delete any user except super admin
        (isSuperAdmin()) ||
        // Super admin email can always delete (for migration purposes)
        (request.auth != null && request.auth.token.email == "joelnithushan6@gmail.com") ||
        // Normal admin can delete regular users only
        (isNormalAdmin() && resource.data.role == 'user')
      ) && !(resource.data.email == "joelnithushan6@gmail.com");
      
      // ========================================
      // USER SUBCOLLECTIONS
      // ========================================
      match /alerts/{alertId} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
      
      match /chats/{chatId} {
        allow read, write: if isOwner(userId) || isAdmin();
        
        // Chat messages subcollection
        match /messages/{messageId} {
          allow read, write: if isOwner(userId) || isAdmin();
        }
      }
      
      // Allow chat collection access for authenticated users
      match /chats {
        allow read, write: if isOwner(userId) || isAdmin();
      }
      
      match /triggeredAlerts/{triggeredAlertId} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
      
      match /crops/{cropId} {
        allow read: if isOwner(userId) || isAdmin();
        allow create: if isOwner(userId) && isValidCropName(request.resource.data.cropName);
        allow update: if isOwner(userId) && (!('cropName' in request.resource.data) || isValidCropName(request.resource.data.cropName));
        allow delete: if isOwner(userId) || isAdmin();
      }
      
      match /fertilizers/{fertilizerId} {
        allow read: if isOwner(userId) || isAdmin();
        allow create: if isOwner(userId) && 
                         request.resource.data.fertilizerName is string &&
                         request.resource.data.fertilizerName.size() > 0;
        allow update: if isOwner(userId) && 
                         (!('fertilizerName' in request.resource.data) || 
                          (request.resource.data.fertilizerName is string && request.resource.data.fertilizerName.size() > 0));
        allow delete: if isOwner(userId) || isAdmin();
        
        match /occurrences/{occId} {
          allow read, write: if isOwner(userId) || isAdmin();
        }
      }
      
      match /recommendations/{recommendationId} {
        allow read: if isOwner(userId) || isAdmin();
        allow create: if isOwner(userId);
        // Recommendations are read-only after creation
      }
      
      match /settings/{settingsId} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
      
      // FIXED: Added explicit schedules subcollection rule for irrigation
      match /irrigation/{docId} {
        allow read, write: if isOwner(userId) || isAdmin();
        
        // CRITICAL FIX: Added schedules subcollection access
        // This was missing and causing permission errors when accessing irrigation/settings/schedules
        match /schedules/{scheduleId} {
          allow read, write: if isOwner(userId) || isAdmin();
        }
      }
    }
    
    // ========================================
    // ROOT LEVEL COLLECTIONS
    // ========================================
    
    // Crops collection (root level - for backward compatibility)
    match /crops/{cropId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       isValidCropName(request.resource.data.cropName);
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin()) &&
                       (!('cropName' in request.resource.data) || isValidCropName(request.resource.data.cropName));
      allow delete: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Additional collections that might be accessed
    match /userSettings/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }
    
    match /systemSettings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /analytics/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }
    
    // Alerts collection (root level)
    match /alerts/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();
      
      match /{alertId} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
    }
    
    // Triggered alerts collection (root level)
    match /triggeredAlerts/{alertId} {
      allow read, write: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // New triggered_alerts collection structure
    match /triggered_alerts/{userId} {
      allow read, write: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      
      match /alerts/{alertId} {
        allow read, write: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      }
    }
    
    // Fertilizers collection (root level)
    match /fertilizers/{fertilizerId} {
      allow read, write: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Recommendations collection (root level)
    match /recommendations/{recommendationId} {
      allow read, write: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Settings collection (root level)
    match /settings/{settingId} {
      allow read, write: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Irrigation collection (root level)
    match /irrigation/{irrigationId} {
      allow read, write: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // ========================================
    // USER PROFILES COLLECTION
    // ========================================
    match /userProfiles/{userId} {
      // READ PERMISSIONS
      allow read: if isOwner(userId) || isAdmin();
      
      // CREATE PERMISSIONS - Allow users to create their own profile
      allow create: if isOwner(userId);
      
      // UPDATE PERMISSIONS - Allow users to update their own profile
      allow update: if isOwner(userId) || isAdmin();
      
      // DELETE PERMISSIONS - Only admins can delete profiles
      allow delete: if isAdmin();
    }
    
    // ========================================
    // DEVICE REQUESTS COLLECTION
    // ========================================
    match /deviceRequests/{requestId} {
      // User can create request for themselves with required fields
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.nicNumber is string &&
                       request.resource.data.nicNumber.size() > 0 &&
                       (request.resource.data.nicNumber.matches('^[0-9]{9}[vV]$') ||
                        request.resource.data.nicNumber.matches('^[0-9]{12}$'));
      
      // User can read their own requests, admins can read all
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      
      // User can delete (cancel) their own pending request
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid &&
                       resource.data.status == 'pending';
      
      // User can update their own request, admins can update all
      allow update: if isAuthenticated() && 
                       (isAdmin() ||
                        // Allow any update for authenticated users to their own requests (temporary for debugging)
                        (resource.data.userId == request.auth.uid));
      
      // Admin has full access
      allow read, write: if isAdmin();
    }
    
    // ========================================
    // ORDERS COLLECTION
    // ========================================
    match /orders/{orderId} {
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
      
      allow delete: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // ========================================
    // DEVICES COLLECTION
    // ========================================
    match /devices/{deviceId} {
      allow read: if isAuthenticated() && 
                     (resource.data.assignedTo == request.auth.uid || isAdmin());
      
      allow update: if isAuthenticated() && 
                       (resource.data.assignedTo == request.auth.uid || isAdmin());
      
      allow create, delete: if isAdmin();
    }
    
    // ========================================
    // FARMS COLLECTION
    // ========================================
    match /farms/{farmId} {
      allow read: if isAuthenticated() && 
                     (resource.data.ownerId == request.auth.uid || 
                      resource.data.userId == request.auth.uid ||
                      isAdmin());
      
      allow create: if isAuthenticated() && 
                       (request.resource.data.ownerId == request.auth.uid || 
                        request.resource.data.userId == request.auth.uid);
      
      allow update: if isAuthenticated() && 
                       (resource.data.ownerId == request.auth.uid || 
                        resource.data.userId == request.auth.uid ||
                        isAdmin());
      
      allow delete: if isAuthenticated() && 
                       (resource.data.ownerId == request.auth.uid || 
                        resource.data.userId == request.auth.uid ||
                        isAdmin());
    }
    
    // ========================================
    // FARM DATA COLLECTION
    // ========================================
    match /farmData/{dataId} {
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
      
      allow delete: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // ========================================
    // SENSOR DATA COLLECTION
    // ========================================
    match /sensorData/{sensorId} {
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
      
      allow read, write: if isAdmin();
    }
    
    // ========================================
    // CHAT SESSIONS COLLECTION
    // ========================================
    match /chatSessions/{sessionId} {
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
      
      allow delete: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // ========================================
    // MESSAGES COLLECTION
    // ========================================
    match /messages/{messageId} {
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
      
      allow delete: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // ========================================
    // FAQS COLLECTION
    // ========================================
    match /faqs/{faqId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // ========================================
    // NOTIFICATIONS COLLECTION
    // ========================================
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      
      allow create: if isAuthenticated() && 
                       (request.resource.data.userId == request.auth.uid || isAdmin());
      
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
      
      allow delete: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // ========================================
    // SYSTEM SETTINGS COLLECTION
    // ========================================
    match /systemSettings/{settingId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // ========================================
    // PASSWORD RESET COLLECTIONS
    // ========================================
    match /passwordResetOTPs/{email} {
      // Only allow server-side operations (no direct client access)
      allow read, write: if false;
    }
    
    match /passwordResetTokens/{token} {
      // Only allow server-side operations (no direct client access)
      allow read, write: if false;
    }
    
    // ========================================
    // AUDIT LOGS COLLECTION
    // ========================================
    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if false;
    }
    
    // ========================================
    // BACKUP DATA COLLECTION
    // ========================================
    match /backupData/{backupId} {
      allow read, write: if isAdmin();
    }
    
    // ========================================
    // DEFAULT DENY RULE
    // ========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
